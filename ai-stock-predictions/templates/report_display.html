{% extends "base.html" %}

{% block title %}Report for {{ ticker | upper }}{% endblock %}

{% block head_scripts %}
    <style>
        /* Container for the entire report view */
        .report-viewer-container {
            padding: 1rem 0; /* Remove horizontal padding, vertical padding optional */
            background-color: #ffffff; /* White background for the content area */
        }

        /* Controls section */
        .report-controls {
            max-width: 1200px; /* Match report content width */
            margin: 0 auto 1.5rem auto; /* Center controls, add bottom margin */
            padding: 0 1rem; /* Add some horizontal padding inside controls */
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .report-controls h2 {
            margin: 0;
            padding-bottom: 0.5rem; /* Space below heading */
            font-size: 1.8rem;
            color: #34495e;
        }

        /* Style for the back button */
        .btn-back {
            display: inline-block;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #fff;
            background-color: #6c757d; /* Secondary color */
            border: none;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn-back:hover {
            background-color: #5a6268;
            color: #fff;
            text-decoration: none;
        }

        /* Loading message style */
        .loading-message {
            text-align: center;
            padding: 4rem 1rem;
            font-size: 1.2rem;
            color: #6c757d;
        }
        .error-message {
            text-align: center;
            padding: 4rem 1rem;
            font-size: 1.1rem;
            color: #dc3545;
            font-weight: 500;
        }
        /* Ensure iframe container allows content to determine height */
        #report-content-area {
             min-height: 100vh; /* Ensure the container takes at least viewport height */
        }
    </style>
{% endblock %}

{% block content %}
<div class="report-viewer-container">
    <div class="report-controls">
        <h2>Analysis Report: {{ ticker | upper }}</h2>
        <a href="{{ url_for('index') }}" class="btn-back">Generate New Report</a>
    </div>

    <div id="report-content-area">
        <p class="loading-message">Loading report content...</p>
        <iframe id="report-iframe" style="display: none; width: 100%; min-height: 100vh; border: none;"></iframe> {# Ensure iframe also takes height #}

        {# Remove any older script block that might have been here #}
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const iframe = document.getElementById('report-iframe');
        const loadingMessage = document.querySelector('.loading-message');
        const reportUrl = "{{ report_url }}"; // Jinja inserts the report URL

        if (reportUrl && reportUrl !== 'None') {
            iframe.src = reportUrl;

            iframe.onload = function() {
                // Hide loading message and show iframe
                loadingMessage.style.display = 'none';
                iframe.style.display = 'block';

                // --- START: Plotly Resize Fix ---
                // Use setTimeout to trigger resize slightly after iframe load finishes,
                // allowing the browser time to finalize layout calculations.
                setTimeout(() => {
                    try {
                        // Access the Plotly object within the iframe
                        const plotlyInstance = iframe.contentWindow.Plotly;

                        // Check if Plotly and its resize function exist
                        if (plotlyInstance && typeof plotlyInstance.Plots !== 'undefined' && typeof plotlyInstance.Plots.resize === 'function') {

                            // Find all Plotly graph divs within the iframe
                            const plotDivs = iframe.contentWindow.document.querySelectorAll('.plotly-graph-div');

                            if (plotDivs.length > 0) {
                                console.log(`Found ${plotDivs.length} Plotly divs. Triggering resize.`);
                                // Call resize for each plot div found
                                plotDivs.forEach(div => {
                                    try {
                                        plotlyInstance.Plots.resize(div);
                                    } catch (resizeError) {
                                         console.error('Error resizing individual plot div:', resizeError, div);
                                    }
                                });
                                console.log('Plotly resize attempt finished.');
                            } else {
                                 console.log('No Plotly divs found in iframe to resize.');
                            }
                        } else {
                            console.log('Plotly.Plots.resize function not found in iframe.');
                        }
                    } catch (error) {
                        console.error('Error accessing iframe content or Plotly:', error);
                    }
                }, 150); // Delay in milliseconds (adjust if needed, 100-250ms is usually sufficient)
                // --- END: Plotly Resize Fix ---
            }; // End iframe.onload

            iframe.onerror = function() {
                loadingMessage.innerHTML = '<p class="error-message">Failed to load report content.</p>';
                iframe.style.display = 'none'; // Hide iframe on error
            };
        } else {
            loadingMessage.innerHTML = '<p class="error-message">Invalid report URL provided.</p>';
        }
    });
</script>
{% endblock %}