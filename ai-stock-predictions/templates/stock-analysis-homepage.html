{% extends "base.html" %}

{% block title %}StockInsight | Market Analysis & Predictions{% endblock %}

{% block head_scripts %}
    <style>
        /* Styles for progress indicator */
        #progress-indicator {
            display: none; /* Hidden by default */
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8f9fa; /* Light background */
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6; /* Subtle border */
        }
        #progress-indicator p#progress-main-message { /* Style for the main "Generating..." message */
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #343a40; /* Darker text */
            font-weight: 600; /* Bolder */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--secondary, #2e86de); /* Use secondary color with fallback */
            animation: spin 1s ease infinite;
            margin: 0 auto 1.5rem auto; /* Center spinner, more space below */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the dynamic step list */
        #progress-steps {
            list-style: none;
            padding: 0;
            margin: 0 auto 1rem auto; /* Center list block */
            font-size: 0.95rem;
            color: #6c757d; /* Muted color for steps */
            text-align: left; /* Align steps left */
            max-width: 300px; /* Limit width */
        }
        #progress-steps li {
            margin-bottom: 0.7rem; /* Increased spacing */
            padding-left: 2rem; /* More indent for icon */
            position: relative;
            opacity: 0.6; /* Default muted state */
            transition: opacity 0.3s ease, color 0.3s ease;
        }
        #progress-steps li.active {
            color: #343a40; /* Darker text when active */
            font-weight: 500;
            opacity: 1;
        }
        #progress-steps li.completed {
            color: #28a745; /* Green when completed */
            font-weight: 500;
            opacity: 1;
        }
        /* Icon styling */
        #progress-steps li::before {
            content: '⏳'; /* Pending icon */
            position: absolute;
            left: 0;
            font-size: 1.1em;
            line-height: 1;
            transition: content 0.3s ease;
        }
        #progress-steps li.active::before {
            content: '⚙️'; /* Active icon */
            animation: spin-step 1.5s linear infinite; /* Subtle spin for active */
        }
        #progress-steps li.completed::before {
            content: '✅'; /* Completed icon */
            animation: none; /* Stop animation */
        }
        @keyframes spin-step {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

         /* Area for error messages */
         #error-message-area {
            color: var(--danger, #dc3545);
            font-weight: bold;
            margin-top: 1rem;
            background-color: #f8d7da; /* Light red background */
            padding: 10px 15px;
            border-radius: 4px;
            display: none; /* Hidden by default */
            border: 1px solid #f5c6cb; /* Red border */
            text-align: center;
        }
         /* Style for timer */
        #timer-message {
            font-size: 0.9rem;
            margin-top: 1.5rem;
            color: #495057; /* Slightly darker grey */
            font-weight: 500;
        }

    </style>
{% endblock %}

{% block content %}
    <section class="hero">
        <div class="container hero-content">
            <div class="hero-text">
                <h1>Smart Stock Predictions & Analysis</h1>
                <p>Enter a stock ticker symbol (e.g., AAPL, MSFT, BRK-A, ^GSPC) to generate a Stock Price Prediction Report with detailed Technical Analysis.</p>

                <form id="ticker-form" class="ticker-form">
                     <input type="text" id="ticker-input" name="ticker" list="ticker-suggestions" placeholder="Enter Stock Ticker (e.g., AAPL)" required title="Enter a valid stock ticker (e.g., MSFT, BRK-A, ^GSPC)." style="padding: 10px; width: 250px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;" autocomplete="off">
                     <small style="display: block; margin-top: 5px; color: rgba(255,255,255,0.7);">Examples: GOOGL, TSLA, BRK-A, ^GSPC</small>
                    <datalist id="ticker-suggestions">
                        <option value="AAPL">
                        <option value="MSFT">
                        <option value="GOOGL">
                        <option value="AMZN">
                        <option value="TSLA">
                        <option value="NVDA">
                        <option value="META">
                        <option value="BRK-A">
                        <option value="BF-B">
                        <option value="^GSPC"> <option value="^IXIC"> <option value="GC=F"> <option value="BTC-USD"> </datalist>
                    <button type="submit" id="generate-button" class="btn btn-primary" style="margin-left: 10px; margin-top: 10px;">Generate Report</button>
                </form>

                <div id="progress-indicator">
                    <p id="progress-main-message">Generating report, please wait...</p>
                    <div class="spinner"></div>
                    <ul id="progress-steps">
                        <li id="step-fetch-hist">Fetching historical data...</li>
                        <li id="step-fetch-macro">Fetching macroeconomic data...</li>
                        <li id="step-preprocess">Preprocessing data...</li>
                        <li id="step-train">Training prediction model...</li>
                        <li id="step-fetch-fund">Fetching fundamentals...</li>
                        <li id="step-generate">Generating Prediction Report...</li>
                        <li id="step-finalize">Finalizing...</li>
                    </ul>
                    <p id="timer-message">Time taken: 0 sec</p>
                </div>

                 <div id="error-message-area"></div>

            </div>
            <div class="hero-chart">
                 <svg width="100%" height="250" viewBox="0 0 500 250">
                    <rect x="0" y="0" width="500" height="250" fill="none" />
                    <g stroke="rgba(255,255,255,0.1)" stroke-width="1">
                        <line x1="0" y1="50" x2="500" y2="50" /> <line x1="0" y1="100" x2="500" y2="100" /> <line x1="0" y1="150" x2="500" y2="150" /> <line x1="0" y1="200" x2="500" y2="200" /> <line x1="50" y1="0" x2="50" y2="250" /> <line x1="150" y1="0" x2="150" y2="250" /> <line x1="250" y1="0" x2="250" y2="250" /> <line x1="350" y1="0" x2="350" y2="250" /> <line x1="450" y1="0" x2="450" y2="250" />
                    </g>
                    <path d="M0,200 L50,180 L100,190 L150,150 L200,140 L250,100 L300,120 L350,80 L400,60 L450,40 L500,50" fill="none" stroke="#10ac84" stroke-width="3" />
                    <path d="M0,200 L50,180 L100,190 L150,150 L200,140 L250,100 L300,120 L350,80 L400,60 L450,40 L500,50 L500,250 L0,250 Z" fill="url(#gradientArea)" opacity="0.3" />
                    <path d="M450,40 L500,50 L550,30" stroke="#2e86de" stroke-width="3" stroke-dasharray="5,5" />
                    <text x="10" y="20" fill="rgba(255,255,255,0.8)" font-size="12">Price</text> <text x="450" y="240" fill="rgba(255,255,255,0.8)" font-size="12">Time</text>
                    <defs> <linearGradient id="gradientArea" x1="0%" y1="0%" x2="0%" y2="100%"> <stop offset="0%" stop-color="#10ac84" stop-opacity="0.7" /> <stop offset="100%" stop-color="#10ac84" stop-opacity="0.1" /> </linearGradient> </defs>
                </svg>
            </div>
        </div>
    </section>

    <section class="features">
       <div class="container">
             <div class="section-title">
                 <h2>Powerful Stock Price Platform</h2>
                 <p>Our advanced platform provides everything you need to make informed investment decisions</p>
             </div>
             <div class="feature-grid">
                 <div class="feature-card"> <div class="feature-icon"> <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline> </svg> </div> <h3>Price Prediction</h3> <p>AI-powered algorithms predict stock movements with remarkable accuracy based on historical data and market trends.</p> </div>
                 <div class="feature-card"> <div class="feature-icon"> <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <circle cx="12" cy="12" r="10"></circle> <line x1="12" y1="16" x2="12" y2="12"></line> <line x1="12" y1="8" x2="12.01" y2="8"></line> </svg> </div> <h3>Technical Analysis</h3> <p>Comprehensive technical indicators and pattern recognition to identify potential entry and exit points.</p> </div>
                 <div class="feature-card"> <div class="feature-icon"> <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect> <line x1="8" y1="21" x2="16" y2="21"></line> <line x1="12" y1="17" x2="12" y2="21"></line> </svg> </div> <h3>Real-time Updates</h3> <p>Stay informed with real-time market data, news alerts, and price notifications for your watchlist.</p> </div>
             </div>
         </div>
    </section>
    <section class="trending-stocks">
         <div class="container">
              <div class="section-title"> <h2>Trending Stocks</h2> <p>Top-performing stocks with our analysis and predictions</p> </div>
              <div class="stock-grid">
                  <div class="stock-card"> <div class="stock-header"> <div class="stock-name">Apple Inc.</div> <div class="stock-symbol">AAPL</div> </div> <div class="stock-price">$187.54</div> <div class="stock-change up"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <polyline points="18 15 12 9 6 15"></polyline> </svg> <span>2.4%</span> </div> <p>Prediction: Strong Buy</p> </div>
                  <div class="stock-card"> <div class="stock-header"> <div class="stock-name">Tesla Inc.</div> <div class="stock-symbol">TSLA</div> </div> <div class="stock-price">$263.21</div> <div class="stock-change up"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <polyline points="18 15 12 9 6 15"></polyline> </svg> <span>4.7%</span> </div> <p>Prediction: Buy</p> </div>
                  <div class="stock-card"> <div class="stock-header"> <div class="stock-name">Microsoft Corp.</div> <div class="stock-symbol">MSFT</div> </div> <div class="stock-price">$342.78</div> <div class="stock-change up"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <polyline points="18 15 12 9 6 15"></polyline> </svg> <span>1.8%</span> </div> <p>Prediction: Strong Buy</p> </div>
                  <div class="stock-card"> <div class="stock-header"> <div class="stock-name">Netflix Inc.</div> <div class="stock-symbol">NFLX</div> </div> <div class="stock-price">$478.36</div> <div class="stock-change down"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <polyline points="6 9 12 15 18 9"></polyline> </svg> <span>0.6%</span> </div> <p>Prediction: Hold</p> </div>
              </div>
          </div>
    </section>
    <section class="cta">
        <div class="container"> <h2>Ready to Make Smarter Investment Decisions?</h2> <p>Join thousands of investors who trust our platform for accurate predictions and in-depth market analysis.</p> <a href="#" class="btn btn-cta">Get Started For Free</a> </div>
    </section>
{% endblock %}

{% block body_scripts %}
    <script>
        // --- JavaScript for Async Form Submission, Progress, Timer, and Redirection ---
        const tickerForm = document.getElementById('ticker-form');
        const tickerInput = document.getElementById('ticker-input');
        const generateButton = document.getElementById('generate-button');
        const progressIndicator = document.getElementById('progress-indicator');
        const progressMainMessage = document.getElementById('progress-main-message');
        const progressSteps = document.getElementById('progress-steps').querySelectorAll('li');
        const timerMessage = document.getElementById('timer-message');
        const errorMessageArea = document.getElementById('error-message-area');

        let timerInterval = null;
        let secondsElapsed = 0;

        // Function to update timer
        function updateTimer() {
            secondsElapsed++;
            timerMessage.textContent = `Time taken: ${secondsElapsed} sec`;
        }

        // Function to update progress steps
        function updateStep(stepIndex, status) {
            if (stepIndex < progressSteps.length) {
                // Remove previous status classes
                progressSteps[stepIndex].classList.remove('active', 'completed');
                if (status === 'active') {
                    progressSteps[stepIndex].classList.add('active');
                    // Mark previous steps as completed
                    for (let i = 0; i < stepIndex; i++) {
                        progressSteps[i].classList.remove('active');
                        progressSteps[i].classList.add('completed');
                    }
                } else if (status === 'completed') {
                    progressSteps[stepIndex].classList.add('completed');
                     // Ensure all previous steps are also marked completed
                    for (let i = 0; i <= stepIndex; i++) {
                        progressSteps[i].classList.remove('active');
                        progressSteps[i].classList.add('completed');
                    }
                }
            }
        }

        // Function to reset progress display
        function resetProgress() {
            progressSteps.forEach(step => {
                step.classList.remove('active', 'completed');
            });
            timerMessage.textContent = 'Time taken: 0 sec';
            secondsElapsed = 0;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            progressIndicator.style.display = 'none';
            errorMessageArea.style.display = 'none';
            generateButton.disabled = false; // Re-enable button
            generateButton.textContent = 'Generate Report';
        }

        tickerForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default synchronous form submission

            const ticker = tickerInput.value.trim().toUpperCase();

            // ***** UPDATED CLIENT-SIDE VALIDATION: Matches backend *****
            const validTickerRegex = /^[A-Z0-9\^.-]+$/; // Allows letters, numbers, caret, dot, hyphen
            if (!ticker || !validTickerRegex.test(ticker)) {
                errorMessageArea.textContent = 'Invalid ticker symbol format. Please use standard symbols (e.g., AAPL, BRK-A, ^GSPC).';
                errorMessageArea.style.display = 'block';
                progressIndicator.style.display = 'none'; // Hide progress
                return;
            }
            // ***** END UPDATED VALIDATION *****


            // Reset previous state and show progress
            resetProgress(); // Reset timer, steps, errors
            progressMainMessage.textContent = `Generating report for ${ticker}, please wait...`; // Update message
            progressIndicator.style.display = 'block'; // Show progress indicator
            generateButton.disabled = true; // Disable button during generation
            generateButton.textContent = 'Generating...';

            // Start timer
            secondsElapsed = 0; // Reset timer count
            timerMessage.textContent = `Time taken: ${secondsElapsed} sec`; // Show 0 sec initially
            timerInterval = setInterval(updateTimer, 1000);

            // --- Simulate Step Progress (as frontend can't directly see backend logs) ---
            // This gives visual feedback even before the fetch completes.
            // Adjust timings as needed to approximate backend process flow.
            updateStep(0, 'active'); // Fetching hist active
            await new Promise(resolve => setTimeout(resolve, 700)); // Simulate time
            updateStep(1, 'active'); // Fetching macro active
            await new Promise(resolve => setTimeout(resolve, 700));
            updateStep(2, 'active'); // Preprocessing active
            await new Promise(resolve => setTimeout(resolve, 1000));
            updateStep(3, 'active'); // Training active
             await new Promise(resolve => setTimeout(resolve, 1500)); // Training might take longer
             updateStep(4, 'active'); // Fetching fund active
             await new Promise(resolve => setTimeout(resolve, 700));
             updateStep(5, 'active'); // Generating sections active
             await new Promise(resolve => setTimeout(resolve, 1000));
             updateStep(6, 'active'); // Finalizing active
            // ------------------------------------------------------------------------

            try {
                // Make asynchronous call to the backend /generate endpoint
                const startTime = performance.now(); // More accurate duration measure
                const response = await fetch("{{ url_for('generate_report') }}", { // Use url_for
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ ticker: ticker })
                });

                // Stop timer when response is received (success or error)
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                 const endTime = performance.now();
                 const preciseDuration = ((endTime - startTime) / 1000).toFixed(2); // Calculate precise duration

                // Check if the request was successful (status code 2xx)
                if (response.ok) {
                    const result = await response.json(); // Parse JSON response
                    console.log("Received result from backend:", result);

                    if (result.status === 'success' && result.viewer_url) {
                        // --- SUCCESS ---
                        updateStep(6, 'completed'); // Mark final step completed
                        timerMessage.textContent = `Report generated! Total time: ${preciseDuration} seconds. Redirecting...`; // Use precise duration
                        progressMainMessage.textContent = `Report for ${result.ticker} ready!`;
                        // Optional: keep progress visible briefly before redirect
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        console.log(`Redirecting to viewer: ${result.viewer_url}`);
                        window.location.href = result.viewer_url; // Redirect

                    } else {
                        // --- BACKEND ERROR ---
                        const message = result.message || 'An unknown error occurred (unexpected response).';
                        errorMessageArea.textContent = `Error: ${message}`;
                        errorMessageArea.style.display = 'block';
                        progressIndicator.style.display = 'none'; // Hide progress on error
                        console.error('Report generation failed (server-side or unexpected response):', result);
                        generateButton.disabled = false; // Re-enable button
                         generateButton.textContent = 'Generate Report';
                    }
                } else {
                    // --- HTTP ERROR ---
                    let message = `HTTP error ${response.status}: ${response.statusText}`;
                    try {
                         const errorResult = await response.json();
                         message = errorResult.message || message;
                         console.error('HTTP Error Response Body:', errorResult);
                    } catch (e) { /* Ignore if response wasn't JSON */ }
                    errorMessageArea.textContent = `Error: ${message}`;
                    errorMessageArea.style.display = 'block';
                    progressIndicator.style.display = 'none'; // Hide progress on error
                    console.error('Report generation failed (HTTP error):', message);
                    generateButton.disabled = false; // Re-enable button
                    generateButton.textContent = 'Generate Report';
                }

            } catch (error) {
                // --- NETWORK/FETCH ERROR ---
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                errorMessageArea.textContent = `Network error or issue connecting to the server: ${error.message}`;
                errorMessageArea.style.display = 'block';
                progressIndicator.style.display = 'none'; // Hide progress on error
                console.error('Report generation failed (network/fetch error):', error);
                generateButton.disabled = false; // Re-enable button
                generateButton.textContent = 'Generate Report';
            }
        });
    </script>
{% endblock %}